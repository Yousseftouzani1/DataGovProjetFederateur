events {}

http {
    # FastAPI backend (auth service)
    upstream auth_api {
        server auth-service:8001;
    }

    server {
        listen 8000;

        # ─────────────────────────────────────────────
        # FRONTEND (Static HTML from auth-serv/frontend)
        # ─────────────────────────────────────────────
        location / {
            root /usr/share/nginx/html;
            index login.html;
        }

        # ─────────────────────────────────────────────
        # TEST ENDPOINT (no /api prefix)
        # Calls FastAPI route: /test-db
        # ─────────────────────────────────────────────
        location /test-db {
            proxy_pass http://auth_api/test-db;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # ─────────────────────────────────────────────
        # API ROUTING (Generic /api/* → FastAPI)
        # Removes /api/ prefix automatically
        # /api/auth/login → /auth/login
        # ─────────────────────────────────────────────
        location /api/ {
            proxy_pass http://auth_api/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
    }
}
